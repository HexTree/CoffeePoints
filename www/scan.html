<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <!--jQuery Scripts
      Necessary for local storage.
    -->
    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
    <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css" />
    <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.5/jquery.mobile.min.css" />
    <link rel="stylesheet" href="vendor/waves/waves.min.css" />
    <link rel="stylesheet" href="vendor/wow/animate.css" />
    <link rel="stylesheet" href="css/nativedroid2.css" />

    <style>
        /* Prevent FOUC */
        body { opacity: 0; }
    </style>
		<meta name="format-detection" content="telephone=no">
		<meta name="msapplication-tap-highlight" content="no">
		<meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">
		<link rel="stylesheet" type="text/css" href="css/index.css">
		<title>Scanner</title>
	</head>
	<body>

		<!-- Refer to the script for changes -->
		<div id="panel"></div>

    <div data-role="header" data-position="fixed" class="wow fadeIn">
        <a href="#leftpanel" class="ui-btn ui-btn-left wow fadeIn" data-wow-delay='0.8s'><i class="zmdi zmdi-menu"></i></a>
        <h1 class="wow fadeIn" data-wow-delay='0.4s'>Scanner</h1>
    </div>

		<div role="main" class="ui-content wow fadeIn" data-inset="false" data-wow-delay="0.2s">
			<div id="lastResult"></div>
      <p>
          <a target="_blank" href="javascript:scan();" style="text-decoration: none"><button class="button">Scan</button></a>
			</p>
			<p align="center" id="messege"></p>
		</div>
		<div data-role="footer" data-position="fixed">
        <div class="col-xs-12 col-sm-12 col-md-12">
            Green Group
        </div>
    </div>
		<script src="id.js"></script>
		<script src="js/loggedin.js"></script>
		<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
		<script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
		<script type="text/javascript" src="cordova.js"></script>
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
		<script src="http://code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>
		<script src="http://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.5/jquery.mobile.min.js"></script>
		<script src="vendor/waves/waves.min.js"></script>
		<script src="vendor/wow/wow.min.js"></script>
		<script src="js/nativedroid2.js"></script>
		<script src="nd2settings.js"></script>
		<script src="cordova.js"></script>
		<script type="text/javascript">

			//Show last result as a table row if exists
			if(window.localStorage.getItem("LastResult")){
					//Render the Table First
					document.getElementById('lastResult').innerHTML = "<p>\n<h3 align='center'>Last Scan</h3>\n<div align='center' data-role='table' class='wow ui-content'>\n<div data-role='header'>\n<td>Time</td>\n<td>Location</td>\n<td>Type</td>\n</div>\n<div data-role='row'>\n<div id='scan'></div>\n</div>\n</div>\n</p>";

					//Show the last result
					var data = window.localStorage.getItem("LastResult");
					var res = data.split("|");
					document.getElementById('scan').innerHTML = '<tr><td>' + res[0]
																										+ '</td><td>' + res[1]
																										+ '</td><td>' + res[2]
																										+ '</td></tr>';
			}

			//Necessary of the date string
			var month = new Array();
			month[0] = "January";
			month[1] = "February";
			month[2] = "March";
			month[3] = "April";
			month[4] = "May";
			month[5] = "June";
			month[6] = "July";
			month[7] = "August";
			month[8] = "September";
			month[9] = "October";
			month[10] = "November";
			month[11] = "December";

			function scan()
			{
				cordova.plugins.barcodeScanner.scan
				(
					function(result)
					{
						if(result.format == "QR_CODE"){
								var value = result.text;

								//Timestamp String
								var d = new Date();
								var date = d.getDate() +'/'+
								 					 month[d.getMonth()] +'/'+
													 d.getFullYear() +'T'+
													 d.getHours() +':'+
													 d.getMinutes() +':'+
													 d.getSeconds();

								//Make sure there is a table first
								if(!window.localStorage.getItem("LastResult")){
									 //Render the Table First
									 document.getElementById('lastResult').innerHTML = "<p>\n<h3 align='center'>Last Scan</h3>\n<div align='center' data-role='table' class='wow ui-content'>\n<div data-role='header'>\n<td>Time</td>\n<td>Location</td>\n<td>Type</td>\n</div>\n<div data-role='row'>\n<div id='scan'></div>\n</div>\n</div>\n</p>";
								}
								//Update LastResult
								var last = date +'|'+ result.text;
								window.localStorage.setItem("LastResult", last);

								//Update LocalData
								window.localStorage.setItem("LocalData", window.localStorage.getItem("LocalData") + '\\' + last);

								//Update the last result
								var data = window.localStorage.getItem("LastResult");
								var res = data.split("|");
								document.getElementById('scan').innerHTML = '<tr><td>' + res[0]
																													+ '</td><td>' + res[1]
																													+ '</td><td>' + res[2]
																													+ '</td></tr>';

								//increment counters
								if (res[2] == "Mug") {
										var mugs = parseInt(window.localStorage.getItem("mugs"));
										window.localStorage.setItem("mugs", mugs + 1);

										var points = parseInt(window.localStorage.getItem("points"));
										window.localStorage.setItem("points", points + 3);
								}
								else if (res[2] == "Bottle") {
										var bottles = parseInt(window.localStorage.getItem("bottles"));
										window.localStorage.setItem("bottles", bottles + 1);

										var points = parseInt(window.localStorage.getItem("points"));
										window.localStorage.setItem("points", points + 2);
								}
								else if (res[2] == "Bag") {
										var bags = parseInt(window.localStorage.getItem("bags"));
										window.localStorage.setItem("bags", bags + 1);

										var points = parseInt(window.localStorage.getItem("points"));
										window.localStorage.setItem("points", points + 3);
								}
						}
						elseif(!result.cancelled){
							document.getElementById("messege").innerHTML = "Messege: You are scanning a " + result.format + ". Please scan a QR code, (They are squared!)";
						}
					},
					function(error)
					{
						//error callback
						document.getElementById("messege").innerHTML = "Error: " + error;
					}
				);
			}
		</script>
	</body>
</html>
